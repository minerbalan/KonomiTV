import{H as Wt,N as Ft,S as Gt}from"./SPHeaderBar-CXBPSjNV.js";import{R as qt}from"./ReservationDetailDrawer-DLps0eQs.js";import{T as fe,a as Xt}from"./TimeTableSettings-osyHvWVr.js";import{d as Be,E as s,U as ve,w as Je,j as Ct,k as de,r as Ue,f as ie,h as L,b as H,B as ze,t as Te,o as B,_ as ke,ah as jt,u as Ie,q as r,ai as Kt,W as R,s as be,aa as Qt,x as et,z as tt,c as O,e as ee,P as $e,n as Ye,a as S,p as gt,V as re,D as xe,F as _e,g as Ce,af as Zt,aj as _t,ak as Jt,M as Ze,Y as yt,l as bt}from"./index-DeuHV4uV.js";import{u as ea,P as ta}from"./ChannelsStore-Dr4OOekO.js";import{u as aa,R as Ve,I as Tt}from"./ServerSettingsStore-Brd5keeW.js";import{V as Ae,d as St}from"./VSelect-DaCxzYjV.js";import{V as wt}from"./VDatePicker-Qv7QIRoR.js";import"./ssrBoot-saFcwPkN.js";import"./VSwitch-EvGbZM2C.js";import"./index-DNCDB5gt.js";import"./VTextField-DasP7VLH.js";import"./VAvatar-CZ-EvYfu.js";import"./VChip-DbrXwLG0.js";import"./VSlider-CdC0KD0P.js";import"./VDialog-K6lQZcq4.js";import"./dialog-transition-DYgjSI4S.js";import"./VCard-CjJaWFKo.js";const la={class:"timetable-channel-header__logo-wrapper"},na=["src","alt"],ia={class:"timetable-channel-header__info"},oa={class:"timetable-channel-header__number"},sa={class:"timetable-channel-header__name"},ra=Be({__name:"TimeTableChannelHeader",props:{channel:{},width:{},height:{},resizeTrigger:{}},setup(te){const l=te,D=s(()=>Math.round(Math.min(46,Math.max(32,l.width*.27)))),v=s(()=>Math.round(D.value*(3/4))),u=s(()=>Math.min(14,Math.max(13,l.width*.06))),P=s(()=>(l.resizeTrigger,Math.min(13.5,Math.max(ve.isSmartphoneVertical()?10:12,l.width*.08)))),w=s(()=>`${l.channel.name} を視聴`);return(t,f)=>{const g=Ue("router-link"),C=Ct("ftooltip");return Je((B(),de(g,{class:"timetable-channel-header",to:`/tv/watch/${t.channel.display_channel_id}`,style:ie({width:`${t.width}px`,height:`${t.height}px`,"--timetable-channel-logo-width":`${D.value}px`,"--timetable-channel-logo-height":`${v.value}px`,"--timetable-channel-number-size":`${u.value}px`,"--timetable-channel-name-size":`${P.value}px`})},{default:L(()=>[H("div",la,[H("img",{class:"timetable-channel-header__logo",loading:"lazy",decoding:"async",src:`${ze(ve).api_base_url}/channels/${t.channel.id}/logo`,alt:t.channel.name},null,8,na)]),H("div",ia,[H("span",oa,Te(t.channel.channel_number),1),H("span",sa,Te(t.channel.name),1)])]),_:1},8,["to","style"])),[[C,w.value,void 0,{bottom:!0}]])}}}),ua=ke(ra,[["__scopeId","data-v-3a5b9c91"]]),xt=["ピン留め","地デジ","BS","CS","CATV","SKY","BS4K"],ca=new Map([["地デジ","GR"],["BS","BS"],["CS","CS"],["CATV","CATV"],["SKY","SKY"],["BS4K","BS4K"]]),Ee=jt("timetable",()=>{const te=Ie(),l=ea(),D=r(null),v=r(M()),u=Kt([]),P=r(null),w=r(!1),t=r(!1),f=r(!1),g=r(0),C=r(null);function $(){const o=R(),b=M();if(v.value.isSame(b,"day")===!1)return!1;let a=o.hour();return a<4&&(a+=24),a>=17}function N(){const o=R(),b=M();if(v.value.isSame(b,"day")===!1)return null;const a=o.startOf("hour").subtract(1,"hour"),y=K();return a.isBefore(y)?y:a}function K(){return f.value?v.value.add(12,"hour"):v.value}function E(o){return o.subtract(1,"millisecond").subtract(4,"hour").startOf("day").add(4,"hour")}function M(){const o=R();let b=o.hour(4).minute(0).second(0).millisecond(0);return o.hour()<4&&(b=b.subtract(1,"day")),b}function W(o,b=!1){return b?o.add(36,"hour"):o.add(1,"day")}const oe=s(()=>f.value?v.value.add(12,"hour"):v.value),F=s(()=>{const o=new Set;if(l.is_channels_list_initial_updated===!1)return o;for(const b of l.channels_list_with_pinned.keys()){if(b==="ピン留め"){const a=l.channels_list_with_pinned.get("ピン留め");if(a===void 0||a.length===0)continue}o.add(b)}return o});function he(){return D.value===null?X():F.value.has(D.value)?null:X()}function X(){if(F.value.has("ピン留め"))return"ピン留め";if(F.value.has("地デジ"))return"地デジ";for(const o of xt)if(F.value.has(o))return o;return"地デジ"}async function Q(o,b,a,y){f.value=$(),C.value=N();const T=o??K(),A=b??W(T,f.value),Y=a??D.value??"地デジ",U=Y==="ピン留め"?y??te.settings.pinned_channel_ids:void 0,ne=ca.get(Y),J=await ta.fetchTimeTable(T,A,ne,U);return J===null?!1:(u.value=J.channels,P.value={earliest:R(J.date_range.earliest),latest:R(J.date_range.latest)},!0)}async function se(){w.value=!0,t.value=!1;try{if(await l.update(),v.value=M(),D.value=X(),await Q()===!1){w.value=!1;return}t.value=!0}finally{w.value=!1}}async function I(o){w.value=!0;try{v.value=o,await Q()}finally{w.value=!1}}async function ae(o){w.value=!0;try{D.value=o,await Q()}finally{w.value=!1}}function V(){let b=R().hour();return b<4&&(b+=24),b>=17}async function G(){if(P.value===null)return;const o=M(),b=V();let a;if(f.value)a=v.value.subtract(1,"day");else if(b){const T=v.value.subtract(1,"day");T.isSame(o.add(1,"day"),"day")?a=o:a=T}else a=v.value.subtract(1,"day");const y=E(P.value.earliest);a.isBefore(y,"day")||await I(a)}async function Z(){if(P.value===null)return;let o;f.value?o=v.value.add(2,"day"):o=v.value.add(1,"day");const b=E(P.value.latest);o.isAfter(b,"day")||await I(o)}async function le(){const o=M();v.value.isSame(o,"day")===!1&&await I(o)}function ue(o){g.value=o}const me=s(()=>{if(P.value===null)return!1;const o=M(),b=V();let a;if(f.value)a=v.value.subtract(1,"day");else if(b){const T=v.value.subtract(1,"day");T.isSame(o.add(1,"day"),"day")?a=o:a=T}else a=v.value.subtract(1,"day");const y=E(P.value.earliest);return a.isSameOrAfter(y,"day")}),ce=s(()=>{if(P.value===null)return!1;let o;f.value?o=v.value.add(2,"day"):o=v.value.add(1,"day");const b=E(P.value.latest);return o.isSameOrBefore(b,"day")});function pe(){u.value=[],P.value=null,w.value=!1,t.value=!1,f.value=!1,g.value=0,C.value=null,D.value=null}return be(()=>te.settings.pinned_channel_ids,async(o,b)=>{D.value==="ピン留め"&&t.value!==!1&&Qt(o,b)===!1&&await Q()},{deep:!0}),be(()=>l.channels_list_with_pinned,async()=>{if(t.value===!1)return;const o=he();o!==null&&await ae(o)},{deep:!0}),{selected_channel_type:D,selected_date:v,channels_data:u,date_range:P,is_loading:w,is_initial_load_completed:t,is_36hour_display:f,date_display_offset:g,scroll_top_limit_time:C,available_channel_types:F,display_start_time:oe,can_go_previous_day:me,can_go_next_day:ce,getBroadcastDate:E,getTodayStartTime:M,getDayEndTime:W,getDisplayStartTime:K,setDateDisplayOffset:ue,fetchTimeTableData:Q,initialLoad:se,changeDate:I,changeChannelType:ae,goToPreviousDay:G,goToNextDay:Z,goToCurrentTime:le,reset:pe}}),da=Be({__name:"TimeTableCurrentTimeLine",props:{hourHeight:{},totalWidth:{},channelHeaderHeight:{}},setup(te){const l=te,D=Ee(),v=r(R());let u=null,P=null;const w=s(()=>{const f=v.value,g=D.getDisplayStartTime(),C=D.getDayEndTime(g,D.is_36hour_display);return f.isSameOrAfter(g)&&f.isBefore(C)}),t=s(()=>{if(!w.value)return 0;const f=D.getDisplayStartTime();return fe.calculateCurrentTimeY(v.value,f,l.hourHeight,l.channelHeaderHeight)-l.channelHeaderHeight});return et(()=>{const f=R(),g=f.add(1,"minute").startOf("minute"),C=Math.max(0,g.valueOf()-f.valueOf());P=setTimeout(()=>{v.value=R(),u=setInterval(()=>{v.value=R()},60*1e3)},C)}),tt(()=>{P!==null&&clearTimeout(P),u!==null&&clearInterval(u)}),(f,g)=>w.value?(B(),O("div",{key:0,class:"timetable-current-time-line",style:ie({top:`${t.value}px`,width:`${f.totalWidth}px`})},g[0]||(g[0]=[H("div",{class:"timetable-current-time-line__indicator"},null,-1),H("div",{class:"timetable-current-time-line__line"},null,-1)]),4)):ee("",!0)}}),va=ke(da,[["__scopeId","data-v-0116f747"]]),ma={class:"timetable-program-cell__content"},fa={class:"timetable-program-cell__header"},ha={class:"timetable-program-cell__start-minute"},pa={key:0,class:"timetable-program-cell__reservation-icon"},ga={key:0,class:"timetable-program-cell__recording-icon"},_a=["innerHTML"],ya=["innerHTML"],ba={key:0,class:"timetable-program-cell__actions"},Ta="fluent:timer-16-filled",Sa="mdi:timer-pause-outline",wa=Be({__name:"TimeTableProgramCell",props:{program:{},channel:{},hourHeight:{},channelWidth:{},fullChannelWidth:{},viewportHeight:{},channelHeaderHeight:{},isScrollAtBottom:{type:Boolean},isSubchannel:{type:Boolean},isSplit:{type:Boolean},isSelected:{type:Boolean},isPast:{type:Boolean},is36HourDisplay:{type:Boolean},isNextReserved:{type:Boolean},resizeTrigger:{}},emits:["click","show-detail","quick-reserve"],setup(te,{emit:l}){const D=new Map;function v(a,y){const T=a.title,A=a.description;if(T===null||A===null)return $e.decorateProgramInfo(a,y);const Y=D.get(a.id);if(Y===void 0||Y.raw_title!==T||Y.raw_description!==A){const ne=$e.decorateProgramInfo(a,"title"),J=$e.decorateProgramInfo(a,"description");D.set(a.id,{raw_title:T,raw_description:A,title:ne,description:J})}const U=D.get(a.id);return U===void 0?$e.decorateProgramInfo(a,y):y==="title"?U.title:U.description}const u=te,P=l,w=Ie(),t=Ee(),f=r(!1),g=r(null),C=r(0),$=s(()=>(u.resizeTrigger,ve.isTouchDevice()?u.isSelected:u.isSelected||w.settings.timetable_hover_expand&&f.value)),N=s(()=>u.program.reservation!==null),K=s(()=>{var a;return((a=u.program.reservation)==null?void 0:a.status)==="Recording"}),E=s(()=>{var a;return((a=u.program.reservation)==null?void 0:a.status)==="Disabled"}),M=s(()=>{var a;return((a=u.program.reservation)==null?void 0:a.recording_availability)==="Partial"}),W=s(()=>{var a;return((a=u.program.reservation)==null?void 0:a.recording_availability)==="Unavailable"}),oe=s(()=>w.settings.timetable_dim_shopping_programs===!1?!1:$e.isShoppingProgram(u.program)),F=s(()=>W.value?"rgb(var(--v-theme-error))":M.value?"rgb(var(--v-theme-warning))":E.value?"rgb(var(--v-theme-text-darken-2))":"rgb(var(--v-theme-secondary))"),he=s(()=>E.value?Sa:Ta),X=s(()=>N.value?E.value?"mdi:timer-play-outline":"mdi:timer-pause-outline":"mdi:timer-plus-outline"),Q=s(()=>{if(u.resizeTrigger,!N.value)return"録画予約";const a=w.settings.timetable_channel_width==="Narrow",y=w.settings.timetable_channel_width!=="Wide",T=ve.isSmartphoneVertical()&&y||(ve.isSmartphoneHorizontal()||ve.isTabletVertical())&&a;return E.value?T?"有効化":"予約を有効化":T?"無効化":"予約を無効化"}),se=s(()=>R(u.program.start_time).minute().toString().padStart(2,"0")),I=s(()=>{var T,A;const a=(A=(T=u.program.genres)==null?void 0:T[0])==null?void 0:A.major;return fe.getGenreColors(a,w.settings.timetable_genre_colors).highlight}),ae=s(()=>{var T,A;if(W.value)return"#f8d7da";if(M.value)return"#fff3cd";const a=(A=(T=u.program.genres)==null?void 0:T[0])==null?void 0:A.major;return fe.getGenreColors(a,w.settings.timetable_genre_colors).background}),V=s(()=>{const a=R(u.program.start_time),y=t.getDisplayStartTime();return fe.calculateProgramY(a,y,u.hourHeight,u.channelHeaderHeight)-u.channelHeaderHeight}),G=s(()=>(u.is36HourDisplay?36:24)*u.hourHeight),Z=s(()=>{const a=fe.calculateProgramHeight(u.program.duration,u.hourHeight);return V.value+a>G.value?Math.max(0,G.value-V.value):Math.max(a,20)}),le=s(()=>{const a=u.fullChannelWidth??u.channelWidth,y=u.isSplit===!0&&u.channelWidth<a,T=$.value&&C.value>0?C.value:Z.value,A=u.isSubchannel&&y?u.channelWidth:0,Y=$.value&&y?0:A,U=$.value&&y?a:u.channelWidth,ne={top:`${V.value}px`,left:`${Y}px`,width:`${U}px`,minHeight:`${Z.value}px`,"--timetable-cell-height":`${T}px`,"--timetable-program-base-background":ae.value,"--timetable-program-base-highlight":I.value};if($.value||(ne.height=`${Z.value}px`),$.value&&u.viewportHeight>0&&u.isScrollAtBottom===!0){const J=C.value>0?C.value:Z.value,ye=Math.max(0,G.value-u.viewportHeight),z=ye+u.viewportHeight,p=V.value+J,i=V.value+Z.value>=G.value-1;if(p>z&&i){const c=p-z,q=Math.max(0,V.value-ye),m=Math.min(c,q);m>0&&(ne.transform=`translateY(-${m}px)`)}}return ne}),ue=s(()=>v(u.program,"title")),me=s(()=>v(u.program,"description"));function ce(){P("click")}function pe(){f.value=!0}function o(){f.value=!1}function b(){P("quick-reserve")}return be($,async a=>{if(a===!1){C.value=0;return}await xe(),g.value!==null&&(C.value=Math.max(g.value.getBoundingClientRect().height,Z.value))}),(a,y)=>{const T=Ue("Icon");return B(),O("div",{class:Ye(["timetable-program-cell",{"timetable-program-cell--selected":a.isSelected,"timetable-program-cell--expanded":$.value,"timetable-program-cell--past":a.isPast,"timetable-program-cell--subchannel":a.isSubchannel,"timetable-program-cell--reserved":N.value,"timetable-program-cell--recording":K.value,"timetable-program-cell--partial":M.value,"timetable-program-cell--unavailable":W.value,"timetable-program-cell--disabled":E.value,"timetable-program-cell--shopping":oe.value,"timetable-program-cell--next-reserved":N.value&&a.isNextReserved}]),ref_key:"cellRef",ref:g,style:ie(le.value),onClick:ce,onMouseenter:pe,onMouseleave:o},[y[2]||(y[2]=H("div",{class:"timetable-program-cell__highlight"},null,-1)),H("div",ma,[H("div",fa,[H("span",ha,Te(se.value),1),N.value?(B(),O("div",pa,[S(T,{icon:he.value,width:"14px",style:ie({color:F.value})},null,8,["icon","style"]),K.value?(B(),O("div",ga)):ee("",!0),M.value?(B(),de(T,{key:1,icon:"fluent:warning-16-filled",width:"12px",class:"timetable-program-cell__warning-icon"})):ee("",!0),W.value?(B(),de(T,{key:2,icon:"fluent:dismiss-circle-16-filled",width:"12px",class:"timetable-program-cell__error-icon"})):ee("",!0)])):ee("",!0)]),H("div",{class:"timetable-program-cell__title",innerHTML:ue.value},null,8,_a),H("div",{class:"timetable-program-cell__description",innerHTML:me.value},null,8,ya),$.value?(B(),O("div",ba,[S(re,{variant:"flat",size:"small",class:"timetable-program-cell__action-button",onClick:y[0]||(y[0]=gt(A=>a.$emit("show-detail"),["stop"]))},{default:L(()=>[S(T,{icon:"fluent:info-12-regular",width:"16px"}),y[1]||(y[1]=H("span",null,"番組詳細",-1))]),_:1,__:[1]}),a.isPast?ee("",!0):(B(),de(re,{key:0,variant:"flat",size:"small",class:Ye(["timetable-program-cell__action-button",{"timetable-program-cell__action-button--reserved":N.value&&!E.value,"timetable-program-cell__action-button--disabled-reservation":E.value}]),onClick:gt(b,["stop"])},{default:L(()=>[S(T,{icon:X.value,width:"16px"},null,8,["icon"]),H("span",null,Te(Q.value),1)]),_:1},8,["class"]))])):ee("",!0)])],38)}}}),Ht=ke(wa,[["__scopeId","data-v-74b796f8"]]),Ha={class:"timetable-time-scale"},Da=["data-hour"],Ca={class:"timetable-time-scale__label"},xa={key:0,class:"timetable-time-scale__date"},Ba={class:"timetable-time-scale__hour-number"},ka=Be({__name:"TimeTableTimeScale",props:{hourHeight:{},is36HourDisplay:{type:Boolean}},setup(te){const l=te,D=Ie(),v=Ee(),u=s(()=>{const f=l.is36HourDisplay?36:24,g=v.display_start_time,C=[];for(let $=0;$<f;$++)C.push(g.add($,"hour"));return C});function P(f){const g=f.hour();return D.settings.use_28hour_clock&&g>=0&&g<=3?(g+24).toString().padStart(2,"0"):g.toString().padStart(2,"0")}function w(f){const g=f.hour(),C=v.display_start_time;return!([0,4,8,12,16,20].includes(g)===!1||l.is36HourDisplay&&g===4&&C.hour()===4)}function t(f){return`${f.month()+1}/${f.date()}`}return(f,g)=>(B(),O("div",Ha,[(B(!0),O(_e,null,Ce(u.value,C=>(B(),O("div",{class:"timetable-time-scale__hour",key:C.valueOf(),style:ie({height:`${l.hourHeight}px`}),"data-hour":C.hour()},[H("div",Ca,[w(C)?(B(),O("span",xa,Te(t(C)),1)):ee("",!0),H("span",Ba,Te(P(C)),1),g[0]||(g[0]=H("span",{class:"timetable-time-scale__hour-label"},"時",-1))])],12,Da))),128))]))}}),Pa=ke(ka,[["__scopeId","data-v-9e862920"]]),Ra={class:"timetable-grid__channel-headers"},Ma={class:"timetable-grid__content"},$a=2,Ia=3,Ea=.5,Oa=60,Va=2,Aa=500,La=120,Dt=.95,Le=.5,Ne=5,Na=100,za=Be({__name:"TimeTableGrid",props:{channels:{},is36HourDisplay:{type:Boolean},canGoPreviousDay:{type:Boolean},canGoNextDay:{type:Boolean}},emits:["time-slot-change","date-display-offset-change","show-program-detail","quick-reserve","go-to-next-day","go-to-previous-day"],setup(te,{expose:l,emit:D}){const v=te,u=D,P=Ie(),w=Ee(),t=r(null),f=r(null),g=r(!1),C=r(!1);let $=0;const N=r(0),K=r(!1),E=r(0),M=r(0),W=r(0),oe=r(0),F=r(null);let he=null,X=null;const Q=r(0),se=new Set;let I=null,ae=null,V=null;const G=r(0),Z=r(0),le=r(!1),ue=r(!1),me=r(!1),ce=r(null),pe=r(0),o=r(0),b=r(0),a=r(0),y=r(!1),T=r(!1),A=r(0),Y=r(0),U=r(0),ne=r(0),J=r(0),ye=r(0),z=r(null),p=s(()=>(G.value,fe.getDeviceType())),i=s(()=>fe.getChannelWidth(P.settings.timetable_channel_width,p.value)),c=s(()=>fe.getHourHeight(P.settings.timetable_hour_height,p.value)),q=s(()=>p.value==="Smartphone"?Ia:$a),m=s(()=>fe.getChannelHeaderHeight(i.value)),Se=s(()=>(G.value,fe.getTimeScaleWidth(p.value,ve.isSmartphoneVertical()))),we=s(()=>v.channels.length*i.value),Pe=s(()=>(v.is36HourDisplay?36:24)*c.value);function We(e){return e.subchannels===null||e.subchannels.length===0?!1:e.subchannels.some(n=>n.programs.length>0)}const Fe=new Map,Re=new Map;function Ge(e){if(e==null)return{start:0,end:0};const n=Fe.get(e.id);if(n!==void 0)return n;const h={start:R(e.start_time).valueOf(),end:R(e.end_time).valueOf()};return Fe.set(e.id,h),h}function at(e,n){const h=Ge(e);return n.some(d=>{const k=Ge(d);return k.start<h.end&&k.end>h.start})}function qe(e,n,h){const d=`${n.id}:${h?"sub":"main"}`,k=Re.get(d);if(k!==void 0)return k;const _=it(e);if(_.length===0)return Re.set(d,!1),!1;if(h){const j=at(n,e.programs);return Re.set(d,j),j}const x=at(n,_);return Re.set(d,x),x}function lt(e,n,h){return qe(e,n,h)?i.value/2:i.value}function De(e){const n=c.value*q.value;E.value=Math.max(0,e-n),M.value=e+N.value+n}function Bt(e){const h=c.value*q.value*Ea,d=e+N.value;return N.value<=0||M.value===0||e<E.value+h||d>M.value-h?(De(e),!0):!1}function nt(e){const n=Ge(e),h=(n.start-Q.value)/(1e3*60*60)*c.value;return(n.end-Q.value)/(1e3*60*60)*c.value>=E.value&&h<=M.value}function kt(e){return e.subchannels===null?[]:e.subchannels}function it(e){return e.subchannels===null?[]:e.subchannels.flatMap(n=>n.programs)}function ot(e){return R(e.end_time).isBefore(R())}function st(e,n,h){const d=h?it(e):e.programs,k=R(n.end_time).valueOf(),_=d.find(x=>R(x.start_time).valueOf()===k);return _!==void 0&&_.reservation!==null}function rt(){if(t.value===null)return;W.value;const e=oe.value;$=e;const n=t.value.clientHeight-m.value;N.value!==n&&(N.value=n);const h=t.value.scrollHeight-t.value.clientHeight,d=e>=h-1;K.value!==d&&(K.value=d),Bt(e)&&Me();const _=e>h-100&&v.canGoNextDay,x=e<100&&v.canGoPreviousDay;g.value!==_&&(g.value=_),C.value!==x&&(C.value=x);const j=w.getDisplayStartTime(),ge=Math.floor(e/c.value);let je=j.add(ge,"hour").hour();je<4&&(je+=24);const zt=Math.floor((je-4)/4)*4+4,Ke=Math.max(4,Math.min(24,zt));if(he!==Ke&&(u("time-slot-change",Ke),he=Ke),v.is36HourDisplay){const Yt=P.settings.use_28hour_clock?4:0;let Oe=j.hour(Yt).minute(0).second(0).millisecond(0);Oe.isSameOrBefore(j)&&(Oe=Oe.add(1,"day"));const Ut=(Oe.valueOf()-j.valueOf())/(1e3*60*60)*c.value,Qe=e>=Ut?1:0;X!==Qe&&(u("date-display-offset-change",Qe),X=Qe)}else X!==0&&(u("date-display-offset-change",0),X=0);ut()}function Pt(){F.value===null&&(F.value=requestAnimationFrame(()=>{F.value=null,rt()}))}function Me(){V===null&&(V=requestAnimationFrame(()=>{V=null,ct()}))}function ut(){ae===null&&(ae=requestAnimationFrame(()=>{ae=null,Rt()}))}function ct(){t.value!==null&&(I!==null&&(I.disconnect(),se.clear()),I=new IntersectionObserver(e=>{for(const n of e){const h=n.target,d=n.rootBounds;if(d===null)continue;const k=n.intersectionRect.top<=d.top,_=n.intersectionRect.height<n.boundingClientRect.height,x=d.height<n.boundingClientRect.height;if(n.isIntersecting&&k&&(_||x))se.add(h),h.classList.add("timetable-program-cell--fixed");else{se.delete(h),h.classList.remove("timetable-program-cell--fixed");const ge=h.querySelector(".timetable-program-cell__content");ge!==null&&(ge.style.paddingTop="")}}ut()},{root:t.value,rootMargin:`-${m.value}px 0px 0px 0px`,threshold:[0,1]}),t.value.querySelectorAll(".timetable-program-cell").forEach(e=>{I==null||I.observe(e)}))}function Rt(){if(t.value===null||se.size===0)return;const e=t.value.getBoundingClientRect().top+m.value;se.forEach(n=>{const h=n.querySelector(".timetable-program-cell__content");if(h===null)return;const d=n.getBoundingClientRect().top,k=e-d;if(k<=0){h.style.paddingTop="";return}const _=n.style.getPropertyValue("--timetable-cell-height"),x=_?Number.parseFloat(_):n.getBoundingClientRect().height,j=Math.max(0,x-Oa),ge=n.classList.contains("timetable-program-cell--reserved")?3:0,pt=Math.min(k,j);h.style.paddingTop=`${Va+Math.max(pt-ge,0)}px`})}let He=null;function dt(){He!==null&&clearTimeout(He),He=window.setTimeout(()=>{G.value++,He=null},Na)}function vt(){Z.value=performance.now()}function Mt(){t.value!==null&&(W.value=t.value.scrollLeft,oe.value=t.value.scrollTop,Pt())}function mt(e){t.value!==null&&(z.value!==null&&(cancelAnimationFrame(z.value),z.value=null),e.deltaX!==0&&(e.preventDefault(),t.value.scrollLeft+=e.deltaX),e.shiftKey&&e.deltaY!==0?(e.preventDefault(),t.value.scrollLeft+=e.deltaY):e.deltaY!==0&&e.deltaX===0&&(e.preventDefault(),t.value.scrollTop+=e.deltaY))}function $t(e){var x;if(e.pointerType==="mouse"===!1)return;const h=((x=e.sourceCapabilities)==null?void 0:x.firesTouchEvents)===!0,k=performance.now()-Z.value<=Aa;if(h||k||t.value===null)return;const _=e.target;_.closest(".v-btn")||_.closest("a")||(ue.value=!0,le.value=!1,y.value=!1,pe.value=e.clientX,o.value=e.clientY,b.value=t.value.scrollLeft,a.value=t.value.scrollTop,z.value!==null&&(cancelAnimationFrame(z.value),z.value=null),Y.value=0,U.value=0,ne.value=performance.now(),J.value=e.clientX,ye.value=e.clientY)}function It(e){if(e.pointerType!=="mouse"||ue.value===!1||t.value===null)return;const n=pe.value-e.clientX,h=o.value-e.clientY;if((Math.abs(n)>Ne||Math.abs(h)>Ne)&&le.value===!1&&t.value!==null&&(le.value=!0,y.value=!0,t.value.setPointerCapture(e.pointerId),me.value=!0,ce.value=e.pointerId),le.value===!1)return;e.preventDefault(),(Math.abs(n)>Ne||Math.abs(h)>Ne)&&(y.value=!0),t.value.scrollLeft=b.value+n,t.value.scrollTop=a.value+h;const d=performance.now(),k=d-ne.value;if(k>0){const _=e.clientX-J.value,x=e.clientY-ye.value;Y.value=-_/k*16,U.value=-x/k*16}ne.value=d,J.value=e.clientX,ye.value=e.clientY}function ft(e){if(e.pointerType==="mouse"&&ue.value!==!1){if(ue.value=!1,le.value=!1,t.value!==null&&me.value&&ce.value!==null)try{t.value.releasePointerCapture(ce.value)}catch{}me.value=!1,ce.value=null,y.value?(Ot(),T.value=!0,A.value=performance.now()):(T.value=!1,A.value=0)}}function Et(e){if(T.value===!1)return;performance.now()-A.value<=La&&(e.preventDefault(),e.stopPropagation()),T.value=!1}function Ot(){if(t.value===null||Math.abs(Y.value)<Le&&Math.abs(U.value)<Le)return;const e=()=>{if(t.value!==null){if(Y.value*=Dt,U.value*=Dt,t.value.scrollLeft+=Y.value,t.value.scrollTop+=U.value,Math.abs(Y.value)<Le&&Math.abs(U.value)<Le){z.value=null;return}z.value=requestAnimationFrame(e)}};z.value=requestAnimationFrame(e)}function ht(e){f.value===e.id?f.value=null:f.value=e.id}function Vt(e){if(t.value===null)return;const h=w.getDisplayStartTime().hour();let k=(e===24?0:e)-h;k<0&&(k+=24);const _=k*c.value;t.value.scrollTo({top:_,behavior:"smooth"})}function At(){const e=w.scroll_top_limit_time;if(e===null)return 0;const n=w.getDisplayStartTime(),d=(e.valueOf()-n.valueOf())/(1e3*60*60);return Math.max(0,d*c.value)}function Xe(e=!0,n=!1){if(t.value===null)return;const h=R(),d=w.getDisplayStartTime(),k=At(),j=(h.subtract(30,"minute").valueOf()-d.valueOf())/(1e3*60*60),ge=Math.max(k,j*c.value);if(n){t.value.scrollTo({top:ge,behavior:e?"smooth":"instant"});return}if(k===0){t.value.scrollTo({top:0,behavior:"instant"});return}t.value.scrollTo({top:k,behavior:"instant"}),e&&setTimeout(()=>{t.value!==null&&t.value.scrollTo({top:ge,behavior:"smooth"})},50)}function Lt(){t.value!==null&&t.value.scrollTo({top:0,behavior:"instant"})}function Nt(){if(t.value===null)return;const e=t.value.scrollHeight-t.value.clientHeight;t.value.scrollTo({top:e,behavior:"instant"})}return l({scrollToHour:Vt,scrollToCurrentTime:Xe,scrollToStart:Lt,scrollToEnd:Nt}),et(async()=>{window.addEventListener("resize",dt),t.value!==null&&t.value.addEventListener("wheel",mt,{passive:!1}),window.addEventListener("touchstart",vt,{passive:!0}),await xe(),t.value!==null&&(W.value=t.value.scrollLeft,oe.value=t.value.scrollTop,rt(),ct()),setTimeout(()=>{Xe(),De($)},100)}),Zt(()=>{window.removeEventListener("resize",dt),window.removeEventListener("touchstart",vt),He!==null&&(clearTimeout(He),He=null),t.value!==null&&t.value.removeEventListener("wheel",mt),F.value!==null&&cancelAnimationFrame(F.value),ae!==null&&cancelAnimationFrame(ae),V!==null&&cancelAnimationFrame(V),I!==null&&(I.disconnect(),I=null,se.clear()),z.value!==null&&cancelAnimationFrame(z.value)}),tt(()=>{z.value!==null&&cancelAnimationFrame(z.value)}),be(()=>v.channels,async(e,n)=>{Fe.clear(),Re.clear(),De($),Me(),n.length===0&&e.length>0&&(await xe(),setTimeout(()=>{Xe(),Me()},100))},{deep:!1}),be([c,N],()=>{De($),Me()}),be(m,()=>{Me()}),be(()=>w.display_start_time,e=>{Q.value=e.valueOf()},{immediate:!0}),(e,n)=>{const h=Ue("Icon");return B(),O("div",{class:"timetable-grid",style:ie({"--timetable-channel-header-height":`${m.value}px`})},[H("div",{class:Ye(["timetable-grid__scroll-area",{"timetable-grid__scroll-area--dragging":le.value}]),ref_key:"scrollAreaRef",ref:t,onScroll:Mt,onPointerdown:$t,onPointermove:It,onPointerup:ft,onPointercancel:ft,onClickCapture:Et},[H("div",{class:"timetable-grid__layout",style:ie({width:`${Se.value+we.value}px`,height:`${m.value+Pe.value}px`})},[H("div",{class:"timetable-grid__header-row",style:ie({height:`${m.value}px`})},[H("div",{class:"timetable-grid__corner",style:ie({width:`${Se.value}px`})},null,4),H("div",Ra,[(B(!0),O(_e,null,Ce(e.channels,d=>(B(),de(ua,{key:d.channel.id,channel:d.channel,width:i.value,height:m.value,resizeTrigger:G.value},null,8,["channel","width","height","resizeTrigger"]))),128))])],4),H("div",{class:"timetable-grid__body-row",style:ie({height:`${Pe.value}px`})},[H("div",{class:"timetable-grid__time-scale",style:ie({width:`${Se.value}px`})},[S(Pa,{hourHeight:c.value,is36HourDisplay:v.is36HourDisplay},null,8,["hourHeight","is36HourDisplay"])],4),H("div",Ma,[(B(!0),O(_e,null,Ce(e.channels,(d,k)=>(B(),O("div",{class:"timetable-grid__channel-column",key:d.channel.id,style:ie({left:`${k*i.value}px`,width:`${i.value}px`,height:`${Pe.value}px`})},[H("div",{class:"timetable-grid__channel-background",style:ie({height:`${Pe.value}px`})},null,4),(B(!0),O(_e,null,Ce(d.programs,_=>(B(),O(_e,{key:_.id},[nt(_)?(B(),de(Ht,{key:0,program:_,channel:d.channel,hourHeight:c.value,channelWidth:lt(d,_,!1),fullChannelWidth:i.value,isSplit:qe(d,_,!1),viewportHeight:N.value,channelHeaderHeight:m.value,isScrollAtBottom:K.value,isSelected:f.value===_.id,isPast:ot(_),is36HourDisplay:v.is36HourDisplay,isNextReserved:st(d,_,!1),resizeTrigger:G.value,onClick:x=>ht(_),onShowDetail:x=>e.$emit("show-program-detail",_.id,d.channel,_),onQuickReserve:x=>e.$emit("quick-reserve",_.id,d.channel,_)},null,8,["program","channel","hourHeight","channelWidth","fullChannelWidth","isSplit","viewportHeight","channelHeaderHeight","isScrollAtBottom","isSelected","isPast","is36HourDisplay","isNextReserved","resizeTrigger","onClick","onShowDetail","onQuickReserve"])):ee("",!0)],64))),128)),We(d)?(B(!0),O(_e,{key:0},Ce(kt(d),_=>(B(),O(_e,{key:_.channel.id},[(B(!0),O(_e,null,Ce(_.programs,x=>(B(),O(_e,{key:x.id},[nt(x)?(B(),de(Ht,{key:0,program:x,channel:_.channel,hourHeight:c.value,channelWidth:lt(d,x,!0),fullChannelWidth:i.value,isSplit:qe(d,x,!0),viewportHeight:N.value,channelHeaderHeight:m.value,isScrollAtBottom:K.value,isSubchannel:!0,isSelected:f.value===x.id,isPast:ot(x),is36HourDisplay:v.is36HourDisplay,isNextReserved:st(d,x,!0),resizeTrigger:G.value,onClick:j=>ht(x),onShowDetail:j=>e.$emit("show-program-detail",x.id,_.channel,x),onQuickReserve:j=>e.$emit("quick-reserve",x.id,_.channel,x)},null,8,["program","channel","hourHeight","channelWidth","fullChannelWidth","isSplit","viewportHeight","channelHeaderHeight","isScrollAtBottom","isSelected","isPast","is36HourDisplay","isNextReserved","resizeTrigger","onClick","onShowDetail","onQuickReserve"])):ee("",!0)],64))),128))],64))),128)):ee("",!0)],4))),128)),S(va,{hourHeight:c.value,totalWidth:we.value,channelHeaderHeight:m.value},null,8,["hourHeight","totalWidth","channelHeaderHeight"])])],4)],4)],34),S(_t,{name:"fade"},{default:L(()=>[g.value?(B(),de(re,{key:0,class:"timetable-grid__next-day-button",variant:"elevated",color:"background-lighten-1",onClick:n[0]||(n[0]=d=>e.$emit("go-to-next-day"))},{default:L(()=>[S(h,{icon:"fluent:chevron-down-20-regular",width:"20px"}),n[2]||(n[2]=H("span",null,"次の日を見る",-1))]),_:1,__:[2]})):ee("",!0)]),_:1}),S(_t,{name:"fade"},{default:L(()=>[C.value?(B(),de(re,{key:0,class:"timetable-grid__prev-day-button",variant:"elevated",color:"background-lighten-1",onClick:n[1]||(n[1]=d=>e.$emit("go-to-previous-day"))},{default:L(()=>[S(h,{icon:"fluent:chevron-up-20-regular",width:"20px"}),n[3]||(n[3]=H("span",null,"前の日を見る",-1))]),_:1,__:[3]})):ee("",!0)]),_:1})],4)}}}),Ya=ke(za,[["__scopeId","data-v-1978aadc"]]),Ua={class:"route-container"},Wa={class:"timetable-controls"},Fa={class:"timetable-controls__date"},Ga={key:0,class:"timetable-controls-mobile"},qa={class:"timetable-controls-mobile__inner"},Xa={class:"timetable-controls-mobile__date"},ja=100,Ka=Be({__name:"TimeTable",setup(te){Ie();const l=Ee(),D=r(null),v=aa(),u=s(()=>v.server_settings),P=s(()=>u.value.general.backend==="EDCB"),w=r(!1),t=r(!1),f=r(0);let g=null;function C(){g!==null&&clearTimeout(g),g=window.setTimeout(()=>{f.value++,g=null},ja)}const $=s(()=>(f.value,ve.isSmartphoneVertical()||ve.isSmartphoneHorizontal()||ve.isTabletVertical())),N=s(()=>(f.value,!ve.isSmartphoneVertical())),K=s(()=>l.date_display_offset),E=r(!1),M=r(null),W=r(null),oe=r(null),F=r(!1),he=s(()=>{const p=[],i=l.available_channel_types;for(const c of xt)i.has(c)&&p.push({title:c,value:c});return p}),X=s({get:()=>l.selected_channel_type,set:p=>{l.changeChannelType(p)}}),Q=s(()=>{const p=[],i=l.is_36hour_display&&K.value===0;for(let c=4;c<=24;c+=4){const q=c,m=c<=12;p.push({title:`${q.toString().padStart(2,"0")}時`,value:c,...i&&m?{props:{disabled:!0}}:{}})}return p});function se(){let i=R().hour();return i<4&&(i+=24),Math.floor((i-4)/4)*4+4}const I=r(se()),ae=s(()=>{const p=l.selected_date.add(K.value,"day"),i=p.month()+1,c=p.date(),q=["日","月","火","水","木","金","土"][p.day()];return`${i}/${c} (${q})`}),V=s({get:()=>l.selected_date.toDate(),set:p=>{const i=R(p).hour(4).minute(0).second(0).millisecond(0);l.changeDate(i)}}),G=s(()=>l.can_go_previous_day),Z=s(()=>l.can_go_next_day),le=s(()=>l.date_range===null?void 0:l.getBroadcastDate(l.date_range.earliest).startOf("day").toDate()),ue=s(()=>l.date_range===null?void 0:l.getBroadcastDate(l.date_range.latest).endOf("day").toDate());function me(p){if(l.date_range===null)return!1;const i=R(p),c=l.getBroadcastDate(l.date_range.earliest),q=l.getBroadcastDate(l.date_range.latest);return i.isSameOrAfter(c,"day")&&i.isSameOrBefore(q,"day")}function ce(p){l.changeChannelType(p)}function pe(p){t.value=!1;const i=R(p).hour(4).minute(0).second(0).millisecond(0);l.changeDate(i)}function o(p){p===null||D.value===null||D.value.scrollToHour(p)}async function b(){await l.goToPreviousDay(),await xe(),D.value!==null&&D.value.scrollToEnd()}async function a(){await l.goToNextDay(),await xe(),D.value!==null&&D.value.scrollToStart()}async function y(){await l.goToCurrentTime(),await xe(),D.value!==null&&D.value.scrollToCurrentTime(!0,!0)}function T(p){const i=Math.floor((p-4)/4)*4+4,c=Math.max(4,Math.min(24,i));I.value=c}function A(p){l.setDateDisplayOffset(p)}async function Y(p,i,c){const q=R(c.end_time);if(F.value=q.isBefore(R()),c.reservation!==null){const m=await Ve.fetchReservation(c.reservation.id);m!==null?(M.value=m,W.value=null,oe.value=null):(M.value=U(c,i),W.value=null,oe.value=null)}else M.value=U(c,i),W.value=null,oe.value=null;E.value=!0}function U(p,i){return{id:-1,channel:i,program:p,is_recording_in_progress:!1,recording_availability:"Full",comment:"",scheduled_recording_file_name:"",estimated_recording_file_size:0,record_settings:structuredClone(Tt)}}async function ne(){await l.fetchTimeTableData()}async function J(){await l.fetchTimeTableData()}async function ye(){await l.fetchTimeTableData()}async function z(p,i,c){if(R(c.end_time).isBefore(R()))return;if(P.value===!1){Ze.warning("録画予約機能は EDCB バックエンド選択時のみ利用できます。");return}if(c.reservation!==null){const Se=await Ve.fetchReservation(c.reservation.id);if(Se===null)return;const we=structuredClone(Se.record_settings);if(we.is_enabled=!we.is_enabled,await Ve.updateReservation(Se.id,we)!==null){const We=we.is_enabled?`録画予約を有効にしました。
番組開始時刻になると自動的に録画が開始されます。`:`録画予約を無効にしました。
番組開始時刻までに再度予約を有効にしない限り、この番組は録画されません。`;Ze.success(We),await l.fetchTimeTableData()}return}await Ve.addReservation(p,structuredClone(Tt))&&(Ze.success("録画予約を追加しました。"),await l.fetchTimeTableData())}return et(async()=>{window.addEventListener("resize",C),await v.fetchServerSettingsOnce(),await l.initialLoad()}),tt(()=>{window.removeEventListener("resize",C),g!==null&&(clearTimeout(g),g=null),l.reset()}),be(()=>l.selected_date,()=>{l.setDateDisplayOffset(0)}),(p,i)=>{const c=Ue("Icon"),q=Ct("ftooltip");return B(),O("div",Ua,[S(Wt,null,Jt({_:2},[$.value?void 0:{name:"timetable-controls",fn:L(()=>[H("div",Wa,[S(Ae,{class:"timetable-controls__channel-type",variant:"outlined",density:"compact","hide-details":"",items:he.value,modelValue:X.value,"onUpdate:modelValue":[i[0]||(i[0]=m=>X.value=m),ce]},null,8,["items","modelValue"]),H("div",Fa,[S(re,{variant:"flat",icon:"",size:"small",disabled:!G.value,onClick:b},{default:L(()=>[S(c,{icon:"fluent:chevron-left-20-regular",width:"20px"})]),_:1},8,["disabled"]),S(St,{modelValue:t.value,"onUpdate:modelValue":i[2]||(i[2]=m=>t.value=m),"close-on-content-click":!1},{activator:L(({props:m})=>[S(re,yt({variant:"flat",class:"timetable-controls__date-button"},m),{default:L(()=>[bt(Te(ae.value),1)]),_:2},1040)]),default:L(()=>[S(wt,{modelValue:V.value,"onUpdate:modelValue":[i[1]||(i[1]=m=>V.value=m),pe],color:"primary",min:le.value,max:ue.value,"allowed-dates":me},null,8,["modelValue","min","max"])]),_:1},8,["modelValue"]),S(re,{variant:"flat",icon:"",size:"small",disabled:!Z.value,onClick:a},{default:L(()=>[S(c,{icon:"fluent:chevron-right-20-regular",width:"20px"})]),_:1},8,["disabled"])]),S(Ae,{class:"timetable-controls__time",variant:"outlined",density:"compact","hide-details":"",items:Q.value,modelValue:I.value,"onUpdate:modelValue":[i[3]||(i[3]=m=>I.value=m),o]},null,8,["items","modelValue"]),Je((B(),de(re,{variant:"flat",class:"timetable-controls__now-button",icon:"",onClick:y},{default:L(()=>[S(c,{icon:"fluent:clock-20-regular",width:"22px"})]),_:1})),[[q,"現在時刻に移動",void 0,{bottom:!0}]]),Je((B(),de(re,{variant:"flat",class:"timetable-controls__settings-button",icon:"",onClick:i[4]||(i[4]=m=>w.value=!0)},{default:L(()=>[S(c,{icon:"fluent:settings-20-regular",width:"22px"})]),_:1})),[[q,"番組表の表示設定",void 0,{bottom:!0}]])])]),key:"0"}]),1024),H("main",null,[S(Ft,{"icon-only":N.value},null,8,["icon-only"]),H("div",{class:Ye(["timetable-container",{"timetable-container--loading":ze(l).is_loading}])},[S(Gt),$.value?(B(),O("div",Ga,[H("div",qa,[S(Ae,{class:"timetable-controls-mobile__channel-type",variant:"outlined",density:"compact","hide-details":"",items:he.value,modelValue:X.value,"onUpdate:modelValue":[i[5]||(i[5]=m=>X.value=m),ce]},null,8,["items","modelValue"]),H("div",Xa,[S(St,{modelValue:t.value,"onUpdate:modelValue":i[7]||(i[7]=m=>t.value=m),"close-on-content-click":!1},{activator:L(({props:m})=>[S(re,yt({variant:"flat",class:"timetable-controls-mobile__date-button",size:"small"},m),{default:L(()=>[bt(Te(ae.value),1)]),_:2},1040)]),default:L(()=>[S(wt,{modelValue:V.value,"onUpdate:modelValue":[i[6]||(i[6]=m=>V.value=m),pe],color:"primary",min:le.value,max:ue.value,"allowed-dates":me},null,8,["modelValue","min","max"])]),_:1},8,["modelValue"])]),S(Ae,{class:"timetable-controls-mobile__time",variant:"outlined",density:"compact","hide-details":"",items:Q.value,modelValue:I.value,"onUpdate:modelValue":[i[8]||(i[8]=m=>I.value=m),o]},null,8,["items","modelValue"]),S(re,{variant:"flat",class:"timetable-controls-mobile__now-button",icon:"",size:"small",onClick:y},{default:L(()=>[S(c,{icon:"fluent:clock-20-regular",width:"18px"})]),_:1}),S(re,{variant:"flat",class:"timetable-controls-mobile__settings-button",icon:"",size:"small",onClick:i[9]||(i[9]=m=>w.value=!0)},{default:L(()=>[S(c,{icon:"fluent:settings-20-regular",width:"18px"})]),_:1})])])):ee("",!0),S(Ya,{ref_key:"timetableGridRef",ref:D,channels:ze(l).channels_data,is36HourDisplay:ze(l).is_36hour_display,canGoPreviousDay:G.value,canGoNextDay:Z.value,onTimeSlotChange:T,onDateDisplayOffsetChange:A,onShowProgramDetail:Y,onQuickReserve:z,onGoToNextDay:a,onGoToPreviousDay:b},null,8,["channels","is36HourDisplay","canGoPreviousDay","canGoNextDay"])],2)]),S(Xt,{isOpen:w.value,"onUpdate:isOpen":i[10]||(i[10]=m=>w.value=m)},null,8,["isOpen"]),S(qt,{modelValue:E.value,"onUpdate:modelValue":i[11]||(i[11]=m=>E.value=m),reservation:M.value,program:W.value,channel:oe.value,isPastProgram:F.value,onAdded:ne,onUpdated:J,onDeleted:ye},null,8,["modelValue","reservation","program","channel","isPastProgram"])])}}}),gl=ke(Ka,[["__scopeId","data-v-c3166b91"]]);export{gl as default};
